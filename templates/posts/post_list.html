{% extends "index.html" %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Add New</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/posts/styles.css' %}">
</head>
<body>
    <div class="container">
        <br><br>
        <!-- Add Post Button -->
        <a href="{% url 'post_create' %}" class="add-post-btn">Create New Post</a>

        <div class="posts">
            {% for post in posts %}
                <div class="post-card">
                    <div class="post-header">
                        <div class="user-info">
                            {% if post.author.profile_picture %}
                                <img src="{{ post.author.profile_picture.url }}" alt="Profile Picture">
                            {% else %}
                                <img src="{% static 'default_profile_pic.png' %}" alt="Default Profile Picture">
                            {% endif %}
                            <div>
                                <h4>{{ post.author.fullname }}</h4>
                                <div class="date">{{ post.created_at|date:"d M Y H:i" }}</div>
                            </div>
                        </div>
                        <div class="post-options">
                            <button type="button" aria-label="Post options" onclick="toggleDropdown(this)">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="dropdown">
                                <nav>
                                    <a href="#"><i class="fas fa-bookmark"></i> Add to favorites</a>
                                    {% if post.author == request.user %}
                                        <a href="{% url 'post_update' post.pk %}"><i class="fas fa-edit"></i> Edit</a>
                                        <a href="javascript:void(0);" onclick="openModal('{{ post.pk }}', '{{ post.title }}')">
                                            <i class="fas fa-trash-alt"></i> Delete 
                                        </a>
                                    {% endif %}
                                </nav>
                            </div>
                        </div>
                    </div>
                    <!-- Post Content -->
                    <div class="post-content">
                        <h4>{{ post.title }}</h4>
                        <p>{{ post.content }}</p>
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="Post Image" loading="lazy">
                        {% endif %}
                    </div>

                    <!-- Comments Section -->
             <!-- Comments Section -->
<div class="comments-section" id="comments-{{ post.id }}">
    <h4>Comments:</h4>
    <div class="comments-wrapper">
        <div class="comments">
            {% for comment in post.comments.all %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <div class="user-info">
                        {% if comment.author.profile_picture %}
                            <img src="{{ comment.author.profile_picture.url }}" alt="Profile Picture">
                        {% else %}
                            <img src="{% static 'default_profile_pic.png' %}" alt="Default Profile Picture">
                        {% endif %}
                    </div>
                    <strong>{{ comment.author.fullname }}</strong>:
                    <p class="comment-content">{{ comment.content }}</p>
                    <span>{{ comment.created_at|date:"d M Y H:i" }}</span>
                    {% if comment.author == user or post.author == user %}
                        <a href="#" class="edit-comment" data-id="{{ comment.id }}">Edit</a>
                        <a href="#" class="delete-comment" data-id="{{ comment.id }}">Delete</a>
                    {% endif %}
                    <div class="edit-comment-container" style="display: none;">
                        <input type="text" class="edit-comment-input" value="{{ comment.content }}">
                        <button class="save-edit" data-id="{{ comment.id }}">Save</button>
                        <button class="cancel-edit">Cancel</button>
                    </div>
                </div>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}
        </div>
    </div>
</div>

                    <!-- Add Comment Form -->
                    <div class="add-comment">
                        <form class="comment-form" action="{% url 'add_comment' post.id %}" method="post">
                            {% csrf_token %}
                            <input type="text" name="content" id="commentInput" placeholder="Add a comment..." required>
                            <button type="button" id="emojiButton">üòä</button> <!-- Emoji Button -->
                            <div id="emojiPicker" class="emoji-picker" style="display: none;">
                                <span class="emoji" data-emoji="üòÄ">üòÄ</span>
                                <span class="emoji" data-emoji="üòÉ">üòÉ</span>
                                <span class="emoji" data-emoji="üòÑ">üòÑ</span>
                                <span class="emoji" data-emoji="üòÅ">üòÅ</span>
                                <span class="emoji" data-emoji="üòÜ">üòÜ</span>
                                <span class="emoji" data-emoji="üòÖ">üòÖ</span>
                                <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                                <span class="emoji" data-emoji="ü§£">ü§£</span>
                                <span class="emoji" data-emoji="üòú">üòú</span>
                                <span class="emoji" data-emoji="üòé">üòé</span>
                            </div>
                            <button type="submit">Add Comment</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>

 

    <!-- Modal HTML Structure -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="postTitle">Delete Confirmation</span>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this post? This action cannot be undone.</p>
                <form id="deleteForm" method="POST">
                    {% csrf_token %}
                    <div class="modal-buttons">
                        <button type="submit" class="btn confirm">Confirm</button>
                        <button type="button" class="btn cancel" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>



        $(document).ready(function() {
            // AJAX submission for new post creation
            $('#newPostForm').on('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission
        
                $.ajax({
                    type: 'POST',
                    url: "{% url 'post_create' %}", // Update with the correct URL for creating a post
                    data: $(this).serialize(), // Serialize the form data
                    success: function(response) {
                        // Append the new post to the posts container
                        $('.posts').prepend(`
                            <div class="post-card">
                                <div class="post-header">
                                    <div class="user-info">
                                        <img src="{% static 'default_profile_pic.png' %}" alt="Default Profile Picture">
                                        <div>
                                            <h4>${response.author}</h4>
                                            <div class="date">${response.created_at}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="post-content">
                                    <h4>${response.title}</h4>
                                    <p>${response.content}</p>
                                </div>
                            </div>
                        `);
        
                        // Clear the form fields
                        $('#title').val('');
                        $('#content').val('');
                    },
                    error: function(xhr, status, error) {
                        console.log("Error:", error);
                    }
                });
            });
        
            // AJAX submission for new comment creation
            $(document).on('submit', '.comment-form', function(event) {
                event.preventDefault();  // Prevent the form from submitting normally
                const form = $(this);
                const postId = form.attr('action').match(/(\d+)/)[0]; // Extract post ID

                $.ajax({
                    type: 'POST',
                    url: form.attr('action'),
                    data: form.serialize(),
                    success: function(data) {
                        // Add new comment to the comments section
                        const newCommentHtml = `
                            <div class="comment" id="comment-${data.id}">
                                <strong>${data.author}</strong>:
                                <p class="comment-content">${data.content}</p>
                                <small>${new Date(data.created_at).toLocaleString()}</small>
                                <a href="#" class="delete-comment" data-id="${data.id}">Delete</a>
                                  <a href="#" class="edit-comment" data-id="${data.id}">Edit</a>
                            </div>`;
                        
                        // Append new comment to the comment section
                        $('#comments-' + postId).find('.comments').append(newCommentHtml);
                        form[0].reset();  // Reset the form
                    },
                    error: function(xhr, status, error) {
                        console.log("Error:", error);
                    }
                });
            });
            //delete
            $(document).on('click', '.delete-comment', function(event) {
        event.preventDefault();
        const commentId = $(this).data('id');
        const commentElement = $('#comment-' + commentId);

        $.ajax({
            type: 'POST',
            url: "{% url 'delete_comment' 0 %}".replace('0', commentId),
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    commentElement.remove(); // Remove the comment from DOM
                } else {
                    console.log("Failed to delete the comment.");
                }
            },
            error: function(xhr, status, error) {
                console.log("Error:", error);
            }
        });
    });

            // Show edit comment input on clicking edit button
            $(document).on('click', '.edit-comment', function(event) {
                event.preventDefault(); 
                const commentId = $(this).data('id');
                const commentElement = $('#comment-' + commentId);
                commentElement.find('.edit-comment-container').show();
                commentElement.find('.comment-content').hide(); // Hide the original content
            });
        
            // Save the edited comment
            $(document).on('click', '.save-edit', function(event) {
    const commentId = $(this).data('id'); // Get the comment ID from the button
    const commentElement = $('#comment-' + commentId);
    const newContent = commentElement.find('.edit-comment-input').val();

    // Construct the correct URL for the edit_comment view
    const editUrl = `/comments/edit/${commentId}/`; // Adjust this based on your URL structure

    $.ajax({
        type: 'POST',
        url: editUrl, // Use the constructed URL
        data: {
            content: newContent,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(data) {
            commentElement.find('.comment-content').text(newContent).show(); // Update comment content
            commentElement.find('.edit-comment-container').hide(); // Hide edit form
        },
        error: function(xhr, status, error) {
            console.log("Error:", error);
        }
    });
});

            // Cancel editing comment
            $(document).on('click', '.cancel-edit', function(event) {
                const commentElement = $(this).closest('.comment');
                commentElement.find('.edit-comment-container').hide(); // Hide edit form
                commentElement.find('.comment-content').show(); // Show original content
            });
        });

        function toggleDropdown(button) {
            const dropdown = $(button).next('.dropdown');
            dropdown.toggle();
        }

        function openModal(postId, postTitle) {
            $('#deleteForm').attr('action', '/delete/' + postId + '/');
            $('#postTitle').text(postTitle);
            $('#deleteModal').show();
        }

        function closeModal() {
            $('#deleteModal').hide();
        }

        $(document).ready(function() {
    // Toggle emoji picker visibility
    $('#emojiButton').on('click', function() {
        $('#emojiPicker').toggle(); // Show/hide emoji picker
    });

    // Insert emoji into input field when clicked
    $(document).on('click', '.emoji', function() {
        const emoji = $(this).data('emoji'); // Get the emoji from data attribute
        const commentInput = $(this).closest('.comment-form').find('#commentInput'); // Find the closest comment input
        commentInput.val(commentInput.val() + emoji); // Append emoji to the input field
        $('#emojiPicker').hide(); // Hide emoji picker after selection
    });
});
    </script>
  
</body>
</html>
{% endblock %}
